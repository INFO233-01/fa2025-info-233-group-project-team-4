# -*- coding: utf-8 -*-
"""
Created on Sat Nov 22 14:37:19 2025

#Researched how to get historical data using chatgpt 

@author: afeak
"""

import requests
from datetime import datetime, timedelta
import random

#need to pip install requests in anaconda prompt so this works 
#Climate retrieval based on last 30 days of temperatures of the countries in our vacation API

# -----------------------------
# 0. OpenWeather API (ADDED)
# -----------------------------
OPENWEATHER_API_KEY = ""   # <--- PUT YOUR KEY HERE (required for weather description)
HEADERS = {
    "User-Agent": "Mozilla/5.0",        # required header so API doesn't block request
    "Accept": "application/json"
}

def get_weather_description(lat, lon):
    """
    Returns the **current weather description** using OpenWeather API.
    Example: "clear sky", "light rain", "broken clouds".
    """
    url = "https://api.openweathermap.org/data/2.5/weather"
    params = {
        "lat": lat,
        "lon": lon,
        "appid": OPENWEATHER_API_KEY,
        "units": "metric"   # request data in Celsius (converted later in the program)
    }
    r = requests.get(url, params=params, headers=HEADERS)
    data = r.json()
    return data["weather"][0]["description"]


# -----------------------------
# 1. Full countries list
# -----------------------------
# This list determines ALL possible countries your program may select from.
countries = [
    "Argentina", "Australia", "Brazil", "Canada", "China", "Egypt", "France", "Germany", "Greece",
    "India", "Indonesia", "Iran", "Iraq", "Ireland", "Italy", "Japan", "Jordan", "Kenya", "Kuwait",
    "Malaysia", "Maldives", "Mexico", "Morocco", "Netherlands", "New Zealand", "NewCountry", "Oman",
    "Palestine", "Peru", "Philippines", "Qatar", "Russia", "Saudi Arabia", "Singapore", "South Africa",
    "South Korea", "Spain", "Sweden", "Switzerland", "Syria", "Thailand", "Tunisia", "Turkey",
    "United Arab Emirates", "United Kingdom", "United States", "Yemen"
]


# -----------------------------
# 2. Approximate latitude & longitude
# -----------------------------
# Each entry matches the same country name in the list above.
# These coordinates are REQUIRED for both APIs (Open Meteo & OpenWeather).
country_coords = {
    "Argentina": (-34.6037, -58.3816),
    "Australia": (-25.2744, 133.7751),
    "Brazil": (-14.2350, -51.9253),
    "Canada": (56.1304, -106.3468),
    "China": (35.8617, 104.1954),
    "Egypt": (26.8206, 30.8025),
    "France": (46.2276, 2.2137),
    "Germany": (51.1657, 10.4515),
    "Greece": (39.0742, 21.8243),
    "India": (20.5937, 78.9629),
    "Indonesia": (-0.7893, 113.9213),
    "Iran": (32.4279, 53.6880),
    "Iraq": (33.2232, 43.6793),
    "Ireland": (53.4129, -8.2439),
    "Italy": (41.8719, 12.5674),
    "Japan": (36.2048, 138.2529),
    "Jordan": (30.5852, 36.2384),
    "Kenya": (-0.0236, 37.9062),
    "Kuwait": (29.3759, 47.9774),
    "Malaysia": (4.2105, 101.9758),
    "Maldives": (3.2028, 73.2207),
    "Mexico": (23.6345, -102.5528),
    "Morocco": (31.7917, -7.0926),
    "Netherlands": (52.1326, 5.2913),
    "New Zealand": (-40.9006, 174.8860),
    "NewCountry": (0.0, 0.0),          # placeholder coordinates
    "Oman": (21.5126, 55.9233),
    "Palestine": (31.9522, 35.2332),
    "Peru": (-9.1899, -75.0152),
    "Philippines": (12.8797, 121.7740),
    "Qatar": (25.3548, 51.1839),
    "Russia": (61.5240, 105.3188),
    "Saudi Arabia": (23.8859, 45.0792),
    "Singapore": (1.3521, 103.8198),
    "South Africa": (-30.5595, 22.9375),
    "South Korea": (35.9078, 127.7669),
    "Spain": (40.4637, -3.7492),
    "Sweden": (60.1282, 18.6435),
    "Switzerland": (46.8182, 8.2275),
    "Syria": (34.8021, 38.9968),
    "Thailand": (15.8700, 100.9925),
    "Tunisia": (33.8869, 9.5375),
    "Turkey": (38.9637, 35.2433),
    "United Arab Emirates": (23.4241, 53.8478),
    "United Kingdom": (55.3781, -3.4360),
    "United States": (39.8283, -98.5795),
    "Yemen": (15.5527, 48.5164)
}

# -----------------------------
# 3. Functions
# -----------------------------
def get_historical_weather(lat, lon, start_date, end_date):
    """
    Retrieves historical **hourly temperatures** for the last 30 days
    using the Open-Meteo archive API.
    """
    url = "https://archive-api.open-meteo.com/v1/archive"
    params = {
        "latitude": lat,
        "longitude": lon,
        "start_date": start_date,
        "end_date": end_date,
        "hourly": ["temperature_2m"],   # request hourly temperature
        "timezone": "auto"
    }
    r = requests.get(url, params=params)
    r.raise_for_status()   # will throw an error if API fails
    return r.json()


def calculate_average_temperature(hourly_data):
    """
    Takes the hourly temperature list and:
    - converts Celsius → Fahrenheit
    - returns average, min, max temps
    """
    temps = hourly_data.get("temperature_2m", [])
    if not temps:
        return None

    temps_f = [t * 9/5 + 32 for t in temps]  # conversion here

    avg_temp = sum(temps_f) / len(temps_f)
    return round(avg_temp, 2), round(min(temps_f), 2), round(max(temps_f), 2)


def climate_description(avg_temp):
    """
    Categorizes the climate based on average °F.
    """
    if avg_temp < 50:
        return "Cold"
    elif avg_temp < 68:
        return "Mild"
    elif avg_temp < 86:
        return "Warm"
        # >= 86°F = Hot
    else:
        return "Hot"


# -----------------------------
# 4. Main program
# -----------------------------
if __name__ == "__main__":
    # Define the 30-day date range
    end_date = datetime.utcnow().date()
    start_date = end_date - timedelta(days=30)

    # Randomly pick 5 countries
    selected_countries = random.sample(countries, 5)  # <<< CHANGE THIS LINE WHEN PARTS ARE MERGED
    # ^ change the number 5 or replace the logic depending on the merged program

    print("Randomly selected countries:", selected_countries, "\n")

    for country in selected_countries:
        lat, lon = country_coords[country]  # get coordinates

        try:
            # 1. Get the historical temperature data
            data = get_historical_weather(lat, lon, start_date.isoformat(), end_date.isoformat())
            hourly = data.get("hourly", {})

            result = calculate_average_temperature(hourly)

            if result is not None:
                avg_temp, min_temp, max_temp = result
                climate = climate_description(avg_temp)

                # -----------------------------
                # ADD WEATHER DESCRIPTION HERE
                # -----------------------------
                try:
                    description = get_weather_description(lat, lon)  # current weather description
                except:
                    description = "Unavailable"

                # Final output for each country
                print(f"{country}: Avg={avg_temp}°F, Min={min_temp}°F, Max={max_temp}°F, Climate={climate}, Weather='{description}'")

            else:
                print(f"{country}: No temperature data available")

        except Exception as e:
            print(f"{country}: Error fetching data ({e})")
